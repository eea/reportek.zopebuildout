===============================================
Zope buildout for https://cdr.eionet.europa.eu/
===============================================

.. contents ::

This buildout will create an isolated environment for running CDR Reportek.
There are three configurations available for running this buildout::

 1. production (production)
 2. testing (staging)
 3. testing dev (staging_dev)
 4. development (devel)


Project name
------------
The project name is CDR: Central Data Repository and it's based on Zope framework.


Prerequisites - System packages
-------------------------------
These should be installed by the sysadmin (needs root)
This buildout was tested on RHEL linux distribution (CentOS 6.5 and 7)
We will need pip to install some python related packages for versions greater
than the python shipped with RHEL 6.5. We will also need additional repos: PUIAS, or
you can use the python 2.7 from software collections here: https://www.softwarecollections.org/en/scls/rhscl/python27/


====================   =============================
CentOS                 dependency for
====================   =============================
apr-util-devel         buildout
cronie                 buildout
curl-devel             buildout
cyrus-sasl-devel       OpenLDAP
gcc                    buildout
gcc-c++                buildout
gdal-libs              reportek-converters
git > 1.8.3            buildout
glibc-devel            buildout
graphviz-devel         reportek-converters
ImageMagick > 6.3.7+   reportek-converters
java-1.6.0-openjdk     reportek-converters
libgsasl-devel         reportek-converters
libjpeg-turbo-devel    Pillow
libxml2-devel          buildout
libxslt-devel          buildout
lynx                   buildout
make                   buildout
mdbtools               reportek-converters
munin-node             buildout
openldap-devel         OpenLDAP
openssl-devel          buildout
p7zip                  reportek-converters
patch                  buildout
perl-XML-SAX           buildout
poppler-utils          reportek-converters
python 2.7             buildout
python-devel           buildout
python-pip             buildout
python-virtualenv      buildout
readline-devel         buildout
redis                  buildout
subversion-devel       buildout
tar                    buildout
unrar                  reportek-converters
unzip                  reportek-converters
wget                   buildout
wv                     http://wvware.sourceforge.net
xlhtml                 reportek-converters
====================   =============================


Additional info to install git for CentOS::

$ wget http://puias.math.ias.edu/data/puias/computational/6/x86_64/git-1.8.3.1-1.sdl6.x86_64.rpm
$ wget http://puias.math.ias.edu/data/puias/computational/6/i386/perl-Git-1.8.3.1-1.sdl6.noarch.rpm
$ yum update  git-1.8.3.1-1.sdl6.x86_64.rpm perl-Git-1.8.3.1-1.sdl6.noarch.rpm

Make sure crond (from cronie package) starts automatically on RHEL systems.

Notes regarding using Reportek buildout with python2.7 as a Software Collection
-------------------------------------------------------------------------------

The buildout can be used with python2.7 installed as a Software Collection, but we need to enable the python27 collection
prior to setting up the buildout or trying to manually start/stop the instances generated by the buildout. Enabling the
python27 software collection can easily be done by issuing the following command::

$ scl enable python27 bash

After this, all other commands/operations are the same as those for system python 2.7. The init script has been adapted to work seamlessly with either system python2.7 and Software Collection python2.7, without any additional step required.

More informations about Software Collection can be found at `https://www.softwarecollections.org/en/`_.

Product directory
~~~~~~~~~~~~~~~~~
::

  $ mkdir -p /var/local/cdr/production


Internal dependencies
---------------------
This buildout depends on us having the following products

 * Products.Reportek https://github.com/eea/Products.Reportek
 * XMLRPCMethod https://svn.eionet.europa.eu/repositories/Zope/trunk/XMLRPCMethod/
 * RDFGrabber https://svn.eionet.europa.eu/repositories/Zope/trunk/RDFGrabber/
 * SmallObligations https://svn.eionet.europa.eu/repositories/Zope/trunk/SmallObligations/
 * reportek-converters https://github.com/eea/reportek-converters


Install Products.Reportek
-------------------------
We shall use virtualenv & co for isolated packages::

  $ cd /var/local/cdr/production
  $ git clone https://github.com/eea/reportek.zopebuildout.git zope
  $ virtualenv prod-venv
  $ . ./prod-venv/bin/activate
  $ pip install -r zope/requirements.txt


Build production
----------------
Note that production will use Products.Reportek from sources (through mr.developer)
https://github.com/eea/Products.Reportek ::

  $ cd /var/local/cdr/production
  $ . prod-venv/bin/activate

Edit secret.cfg and change all the passwords. This file should not be added to Git because it is secret :). ::

  $ cd zope
  $ cp buildout-configs/secret.cfg.sample buildout-configs/secret.cfg
  $ vim secret.cfg
  $ ./install.sh production.cfg

Run buildout using the production.cfg configuration ::

  $ ./bin/buildout -c production.cfg

For the application stack to be restarted when server reboot, the system administrator should add under /etc/init.d the script from /var/local/cdr/production/etc/rc.d/cdrctl, e.g.::

  $ cd /var/local/cdr/production/etc/rc.d
  $ sudo ln -s `pwd`/cdrctl /etc/init.d/cdrctl
  $ sudo chkconfig --add cdrctl
  $ sudo chkconfig cdrctl on
  $ sudo service cdrctl start

Check the status and see if all the procs started with ::

  $ sudo service cdrctl status

or if you're using CentOS 7, there will be an autogenerated systemd process generated for you automatically and you can check the status with ::

  $ sudo systemctl status cdrctl.service

Restart with ::

  $ sudo service cdrctl restart

or for systemd ::

  $ sudo systemctl restart cdrctl.service

Build staging
-------------
This deployment is what runs behind https://cdrtest.eionet.europa.eu/
Note that staging will use Products.Reportek from sources (through mr.developer)
https://github.com/eea/Products.Reportek ::

  $ mkdir -p /var/local/cdr/staging
  $ cd /var/local/cdr/staging
  $ git clone https://github.com/eea/reportek.zopebuildout.git zope
  $ virtualenv staging-venv
  $ . staging-venv/bin/activate
  $ pip install -r zope/requirements-staging.txt

Edit secret.cfg and change all the passwords. This file should not be added to Git because it is secret :). ::

  $ cd zope
  $ cp buildout-configs/secret.cfg.sample buildout-configs/secret.cfg
  $ vim secret.cfg
  $ ./install.sh staging.cfg

Run buildout using the staging.cfg configuration::

  $ ./bin/buildout -c staging.cfg

For the application stack to be restarted when server reboot, the system administrator should add under /etc/init.d the script from /var/local/cdr/staging/etc/rc.d/cdrtestctl, e.g.::

  $ sudo cd /var/local/cdr/staging/etc/rc.d
  $ sudo ln -s `pwd`/cdrtestctl /etc/init.d/cdrtestctl
  $ sudo chkconfig --add cdrtestctl
  $ sudo chkconfig cdrtestctl on
  $ sudo service cdrtestctl start

Check the status and see if all the procs started with ::

  $ sudo service cdrtestctl status

or if you're using CentOS 7, there will be an autogenerated systemd process generated for you automatically and you can check the status with ::

  $ sudo systemctl status cdrtestctl.service

Restart with ::

  $ sudo service cdrtestctl restart

or for systemd ::

  $ sudo systemctl restart cdrtestctl.service

Build devel
-------------
Note that devel will use Products.Reportek from sources (through mr.developer)
https://github.com/eea/Products.Reportek but has always-checkout = false so 
that you can control the version of your sources::

  $ mkdir -p /var/local/cdr/devel
  $ cd /var/local/cdr/devel
  $ git clone git clone https://github.com/eea/reportek.zopebuildout.git zope
  $ virtualenv devel-venv
  $ . devel-venv/bin/activate
  $ pip install -r zope/requirements-dev.txt

Edit secret.cfg and change all the passwords. This file should not be added to Git because it is secret :). ::

  $ cd zope
  $ cp buildout-configs/secret.cfg.sample buildout-configs/secret.cfg
  $ vim secret.cfg
  $ ./install.sh devel.cfg

Run buildout using the devel.cfg configuration::

  $ ./bin/buildout -c devel.cfg
  $ ./bin/instance fg

Find out what dir the reportek.converters egg is intalled to and start gunicorn::
  * $ cd eggs/reportek.converters-<ver>.egg/Products/reportek.converters/ && ../../../../zope/bin/gunicorn -b localhost:5002 web:app


Generate documentation
----------------------
Before generate documentation set variable DOCS_PATH from secret.cfg, to the
path where the program will save the documentation.

To generate documentation::

 $ ./make-docs

To delete all documentation::

 $ ./bin/clean-docs

**Be carefull with clean-docs because it removes the whole content of the folder 
DOCS_PATH.**

===========================
Apache vhost configurations
===========================
An apache vhost configuration file is automatically generated by the buildout system for production and staging deployments.
It is located in the <buildout-directory>/etc/ and has the following naming convention: `apache-vh-<data-registry>.conf`.
The template used for the configuration file generation is found here: https://svn.eionet.europa.eu/repositories/VhostsDataRepo/cdr/apache-vh-<data-registry>.tpl
The `data-registry` variable is setup in the buildout and depending on your buildout setup can be::

* cdr
* cdrtest
* cdrdev

The generated apache vhost config file can then be symlinked in the in your apache installation directory like so (Remember to replace <data-registry> with
your deployment type)::

  $ cd /var/local/cdr/production/etc/rc.d
  $ sudo ln -s `pwd`/apache-vh-<data-registry>.conf /etc/httpd/conf.d/apache-vh-<data-registry>.conf
  $ sudo apachectl graceful

========
Contacts
========
The project owner is Søren Roug (soren.roug at eaa.europa.eu)

Other people involved in this project are::
 - Cornel Nițu (cornel.nitu at eaudeweb.ro)
 - Miruna Bădescu (miruna.badescu at eaudeweb.ro)
 - Daniel Mihai Bărăgan (daniel.baragan at eaudeweb.ro)


=========
Resources
=========
Minimum requirements:
 * 2048MB RAM
 * 2 CPU 1.8GHz or faster
 * 4GB hard disk space

Recommended:
 * 4096MB RAM
 * 4 CPU 2.4GHz or faster
 * 8GB hard disk space


=====================
Copyright and license
=====================
Copyright 2007 European Environment Agency (EEA)

Licensed under the EUPL, Version 1.1 or – as soon they will be approved
by the European Commission - subsequent versions of the EUPL (the "Licence");

You may not use this work except in compliance with the Licence.

You may obtain a copy of the Licence at:
https://joinup.ec.europa.eu/software/page/eupl/licence-eupl

Unless required by applicable law or agreed to in writing, software distributed under the Licence is distributed on an "AS IS" basis,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.

See the Licence for the specific language governing permissions and limitations under the Licence.

.. _`https://www.softwarecollections.org/en/`: https://www.softwarecollections.org/en/
